
version: '3.4'

services:
  rabbitmq:
    image: rabbitmq:3-management-alpine
    ports:
      - "15672:15672"
      - "5671:5671"
      - "5672:5672"
    environment:
      RABBITMQ_DEFAULT_PASS: password
      RABBITMQ_DEFAULT_USER: admin

  # storage:
  #   image: openzipkin/zipkin-mysql
  #   container_name: mysql
  #   # Uncomment to expose the storage port for testing
  #   # ports:
  #   #   - 3306:3306

  # # The zipkin process services the UI, and also exposes a POST endpoint that
  # # instrumentation can send trace data to. Scribe is disabled by default.
  # zipkin:
  #   image: openzipkin/zipkin
  #   container_name: zipkin
  #   # Environment settings are defined here https://github.com/openzipkin/zipkin/blob/master/zipkin-server/README.md#environment-variables
  #   environment:
  #     - STORAGE_TYPE=mysql
  #     # Point the zipkin at the storage backend
  #     - MYSQL_HOST=mysql
  #     # Uncomment to enable scribe
  #     # - SCRIBE_ENABLED=true
  #     # Uncomment to enable self-tracing
  #     # - SELF_TRACING_ENABLED=true
  #     # Uncomment to enable debug logging
  #     # - JAVA_OPTS=-Dlogging.level.zipkin2=DEBUG
  #   ports:
  #     # Port used for the Zipkin UI and HTTP Api
  #     - 9411:9411
  #     # Uncomment if you set SCRIBE_ENABLED=true
  #     # - 9410:9410
  #   depends_on:
  #     - storage

  order.api:
    build:
      context: .
      dockerfile: NET6.Microservice.Order.API/Dockerfile
    ports:
      - "5089:80"
    environment:
      #- ASPNETCORE_ENVIRONMENT=Production
      - Serilog:WriteTo:0:Args:path=/app/logs/NET6.Microservice.Order.API.logs.json
      - MassTransit:MessageBusRabbitMQ=amqp://admin:password@rabbitmq:5671/
    depends_on:
      - rabbitmq

  catalog.api:
    build:
      context: .
      dockerfile: NET6.Microservice.Catalog.API/Dockerfile
    ports:
      - "5226:80"
    environment:
      #- ASPNETCORE_ENVIRONMENT=Production
      - Serilog:WriteTo:0:Args:path=/app/logs/NET6.Microservice.Catalog.API.logs.json
      - MassTransit:MessageBusRabbitMQ=amqp://admin:password@rabbitmq:5671/
    depends_on:
      - rabbitmq

  workerservice:
    build:
      context: .
      dockerfile: NET6.Microservice.WorkerService/Dockerfile
    environment:
      #- ASPNETCORE_ENVIRONMENT=Production
      - Serilog:WriteTo:0:Args:path=/app/logs/NET6.Microservice.WorkerService.logs.json
      - MassTransit:MessageBusRabbitMQ=amqp://admin:password@rabbitmq:5671/
    depends_on:
      - rabbitmq
